using UnityEngine;
using System.Collections;

public class AttackManager : MonoBehaviour {
	
	private static AttackManager instance;
	public static AttackManager Instance
	{
		get
		{
			if (instance == null)
			{
				instance = GameObject.FindGameObjectWithTag("Globals").GetComponent<AttackManager>();
			}
			return instance;
		}
	}
	private GameObject pOne;
	private GameObject pTwo;
	private PlayerOneAttack pOneAttack;
	private PlayerTwoAttack pTwoAttack;
	public int pOneScore = 0;
	public int pTwoScore = 0;
	public GUIText pOneScoreText;
	public GUIText pTwoScoreText;
	private PlayerOneMovement pOneMove;
	private PlayerTwoMovement pTwoMove;
	public Vector3 pOneStartSpace;
	public Vector3 pTwoStartSpace;
	public Vector3 pOneStepSpace;
	public Vector3 pTwoStepSpace;
	public bool resetingPositions = false;
	public bool stepBack = false;


	public AudioClip hit;
	public AudioClip block;

	// Use this for initialization
	void Start () {
		pOne = GameObject.FindGameObjectWithTag("Player1");
		pOneAttack = pOne.GetComponent<PlayerOneAttack>();
		pOneMove = pOne.GetComponent<PlayerOneMovement>();
		pTwo = GameObject.FindGameObjectWithTag("Player2");
		pTwoAttack = pTwo.GetComponent<PlayerTwoAttack>();
		pTwoMove = pTwo.GetComponent<PlayerTwoMovement>();

		pOneScoreText.text = "" + pOneScore;
		pTwoScoreText.text = "" + pTwoScore;

		pOneStartSpace = new Vector3(-3.3f, -0.33f, 0);
		pTwoStartSpace = new Vector3(3.3f, -0.33f, 0);
	}
	
	// Update is called once per frame
	void Update () {
		if(!resetingPositions)
		{
			stepBack = false;
		}
	}
	
	public void ResolveAttack(bool pOneAct, bool pTwoAct){
		//Debug.Log(pTwoAttack.attackCommitted);

		// Player One.
		if (pOneAttack.attackCommitted && pOneAttack.attackState == 3)
		{
			pOneAttack.spriteRend.sprite = pOneAttack.highAttack;
		}
		else if (pOneAttack.attackCommitted && pOneAttack.attackState == 1)
		{
			pOneAttack.spriteRend.sprite = pOneAttack.lowAttack;
		}
		else if(pOneAct && !pOneAttack.attackCommitted)
		{
			pOneAttack.attackState = 2;
			pOneAttack.spriteRend.sprite = pOneAttack.midAttack;
		}
		else if(!pOneAct && !pOneAttack.attackCommitted)
		{
			pOneAttack.attackState = 0;
			pOneAttack.spriteRend.sprite = pOneAttack.nullAttack;
		}

		// Player Two.
		if (pTwoAttack.attackCommitted && pTwoAttack.attackState == 3)
		{
			pTwoAttack.spriteRend.sprite = pTwoAttack.highAttack;
		}
		else if (pTwoAttack.attackCommitted && pTwoAttack.attackState == 1)
		{
			pTwoAttack.spriteRend.sprite = pTwoAttack.lowAttack;
		}
		else if (pTwoAct && !pTwoAttack.attackCommitted)
		{
			pTwoAttack.attackState = 2;
			pTwoAttack.spriteRend.sprite = pTwoAttack.midAttack;
		}
		else if(!pTwoAct && !pTwoAttack.attackCommitted)
		{
			pTwoAttack.attackState = 0;
			pTwoAttack.spriteRend.sprite = pTwoAttack.nullAttack;
		}

		if(Mathf.Abs(pOne.transform.position.x - pTwo.transform.position.x) < .7f)
		{
			if(pOneAttack.attackState > pTwoAttack.attackState && (pOneAttack.attackState != 3 || pTwoAttack.attackState != 1))
			{
				pOneScore ++;
				audio.clip = hit;
				audio.Play();
				resetingPositions = true;
				/*pOne.transform.position = pOneStartSpace;
				pTwo.transform.position = pTwoStartSpace;
				pOneMove.xPosition = pOne.transform.position.x;
				pTwoMove.xPosition = pTwo.transform.position.x;*/
			}
			if(pOneAttack.attackState == 3 && pTwoAttack.attackState == 1)
			{
<<<<<<< HEAD
				pOneAttack.parried = true;
				pOneAttack.spriteRend.sprite = pOneAttack.parriedAttack;
=======
				pTwoScore ++;
				audio.clip = hit;
				audio.Play();
				resetingPositions = true;
				/*pOne.transform.position = pOneStartSpace;
				pTwo.transform.position = pTwoStartSpace;
				pOneMove.xPosition = pOne.transform.position.x;
				pTwoMove.xPosition = pTwo.transform.position.x;*/
>>>>>>> 5749c74196c7cf5b155b42e1afe2d6c1b723e5bf
			}
			if(pTwoAttack.attackState > pOneAttack.attackState && (pTwoAttack.attackState != 3 || pOneAttack.attackState != 1))
			{
				pTwoScore ++;
				audio.clip = hit;
				audio.Play();
				resetingPositions = true;
				/*pOne.transform.position = pOneStartSpace;
				pTwo.transform.position = pTwoStartSpace;
				pOneMove.xPosition = pOne.transform.position.x;
				pTwoMove.xPosition = pTwo.transform.position.x;*/
			}
			if(pTwoAttack.attackState == 3 && pOneAttack.attackState == 1)
			{
<<<<<<< HEAD
				pTwoAttack.parried = true;
				pTwoAttack.spriteRend.sprite = pTwoAttack.parriedAttack;
=======
				pOneScore ++;
				audio.clip = hit;
				audio.Play();
				resetingPositions = true;
				/*pOne.transform.position = pOneStartSpace;
				pTwo.transform.position = pTwoStartSpace;
				pOneMove.xPosition = pOne.transform.position.x;
				pTwoMove.xPosition = pTwo.transform.position.x;*/
>>>>>>> 5749c74196c7cf5b155b42e1afe2d6c1b723e5bf
			}
			if(pOneAttack.attackState == pTwoAttack.attackState)
			{
				audio.clip = block;
				audio.Play();
				resetingPositions = true;
				stepBack = true;

			}
			if (resetingPositions)
			{
				pOneMove.maxX = -3;
				pTwoMove.minX = 3;
				BeatManager.Instance.pOneBackedUp = BeatManager.Instance.pTwoBackedUp = false;
			}
			if (stepBack)
			{
				pOneStepSpace = pOne.transform.position;
				pOneStepSpace.x = pOne.transform.position.x - 1.0f;
				
				pTwoStepSpace = pTwo.transform.position;
				pTwoStepSpace.x = pTwo.transform.position.x + 1.0f;
			}


		}

		pOneScoreText.text = "" + pOneScore;
		pTwoScoreText.text = "" + pTwoScore;

		pOneAttack.attackCommitted = false;
		pTwoAttack.attackCommitted = false;
	}
}

